{{> menu active="dashboard" }}

<section class="section">
  <h1 class="title">Welcome to your Dashboard</h1>
  
  <div class="box">
    <div class="level">
      <div class="level-left">
         <h2 class="title is-5">Map</h2>
      </div>
      <div class="level-right">
        <div class="field is-horizontal">
          <div class="field-label is-normal">
            <label class="label">Filter Category</label>
          </div>
          <div class="field-body">
            <div class="field">
              <div class="control">
                <div class="select">
                  <select id="category-filter">
                    <option value="all">All</option>
                    <option value="marina">Marina</option>
                    <option value="anchorage">Anchorage</option>
                    <option value="beach">Beach</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="columns">
      <div class="column">
        <h3 class="subtitle">Standard</h3>
        <div id="map-dashboard" style="height: 400px; width: 100%;"></div>
      </div>
      <div class="column">
        <h3 class="subtitle">Satellite</h3>
        <div id="map-satellite" style="height: 400px; width: 100%;"></div>
      </div>
      <div class="column">
        <h3 class="subtitle">Nautical (OpenSeaMap)</h3>
        <div id="map-nautical" style="height: 400px; width: 100%;"></div>
      </div>
    </div>
  </div>

  <div>
  {{> list-placemarks}}
  {{> add-placemark}}
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize maps
    const map = L.map('map-dashboard').setView([51.505, -0.09], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const mapSat = L.map('map-satellite').setView([51.505, -0.09], 2);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(mapSat);

    const mapNautical = L.map('map-nautical').setView([51.505, -0.09], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mapNautical);
    L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
      attribution: 'Map data: &copy; <a href="http://www.openseamap.org">OpenSeaMap</a> contributors'
    }).addTo(mapNautical);

    // Get placemarks data
    const placemarks = {{{json placemarks}}};
    const markers = []; // for map
    const markersSat = []; // for mapSat
    const markersNautical = []; // for mapNautical
    const categoryFilter = document.getElementById('category-filter');

    function renderMarkers(filter) {
      // Clear existing markers
      markers.forEach(m => map.removeLayer(m));
      markers.length = 0;
      
      markersSat.forEach(m => mapSat.removeLayer(m));
      markersSat.length = 0;
      
      markersNautical.forEach(m => mapNautical.removeLayer(m));
      markersNautical.length = 0;

      placemarks.forEach(pm => {
        if (filter === 'all' || pm.category === filter) {
          if (pm.latitude && pm.longitude && (pm.latitude !== 0 || pm.longitude !== 0)) {
            const popupContent = `<b>${pm.title}</b><br>${pm.category}`;
            
            const marker = L.marker([pm.latitude, pm.longitude]).bindPopup(popupContent);
            marker.addTo(map);
            markers.push(marker);
            
            const markerSat = L.marker([pm.latitude, pm.longitude]).bindPopup(popupContent);
            markerSat.addTo(mapSat);
            markersSat.push(markerSat);
            
            const markerNautical = L.marker([pm.latitude, pm.longitude]).bindPopup(popupContent);
            markerNautical.addTo(mapNautical);
            markersNautical.push(markerNautical);
          }
        }
      });
      
      if (markers.length > 0) {
          const group = new L.featureGroup(markers);
          const bounds = group.getBounds();
          map.fitBounds(bounds);
          mapSat.fitBounds(bounds);
          mapNautical.fitBounds(bounds);
      }
    }

    // Initial render
    renderMarkers('all');

    // Filter change event
    categoryFilter.addEventListener('change', (e) => {
      renderMarkers(e.target.value);
    });
  });
</script>